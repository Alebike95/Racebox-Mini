<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>RaceBox Mini ‚Äì GNSS Dashboard</title>
  <style>
    body {
      font-family: system-ui, monospace;
      background: #0b0b0b;
      color: #00ff9c;
      padding: 20px;
    }
    button {
      padding: 10px 15px;
      font-size: 16px;
      margin-right: 10px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .card {
      background: #111;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 0 10px #000;
    }
    .label {
      font-size: 14px;
      opacity: 0.7;
    }
    .value {
      font-size: 26px;
      font-weight: bold;
    }
    .small {
      font-size: 18px;
    }
  </style>
</head>
<body>

<h1>üèÅ RaceBox Mini ‚Äì GNSS Dashboard</h1>

<button id="connect">üîó Connetti RaceBox</button>

<div class="grid">
  <div class="card"><div class="label">Fix</div><div id="fix" class="value">‚Äì</div></div>
  <div class="card"><div class="label">Satelliti</div><div id="sv" class="value">‚Äì</div></div>
  <div class="card"><div class="label">Latitudine</div><div id="lat" class="value small">‚Äì</div></div>
  <div class="card"><div class="label">Longitudine</div><div id="lon" class="value small">‚Äì</div></div>
  <div class="card"><div class="label">Velocit√†</div><div id="speed" class="value">‚Äì km/h</div></div>
  <div class="card"><div class="label">Heading</div><div id="heading" class="value">‚Äì ¬∞</div></div>
  <div class="card"><div class="label">Accuratezza</div><div id="acc" class="value">‚Äì m</div></div>
  <div class="card"><div class="label">Frequenza</div><div id="hz" class="value">‚Äì Hz</div></div>
</div>

<script>
const UART_SERVICE = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const UART_TX = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

let lastPacketTime = null;
let hzCounter = [];

function u32(d, o) {
  return d[o] | (d[o+1]<<8) | (d[o+2]<<16) | (d[o+3]<<24);
}
function i32(d, o) {
  return (u32(d,o) << 0);
}
function u16(d, o) {
  return d[o] | (d[o+1]<<8);
}

function parseRaceBoxPacket(data) {
  // Check UBX header
  if (data[0] !== 0xB5 || data[1] !== 0x62) return null;
  if (data[2] !== 0xFF || data[3] !== 0x01) return null;

  const payloadStart = 6;

  const year   = u16(data, payloadStart + 4);
  const month  = data[payloadStart + 6];
  const day    = data[payloadStart + 7];
  const hour   = data[payloadStart + 8];
  const min    = data[payloadStart + 9];
  const sec    = data[payloadStart +10];

  const fixType = data[payloadStart +11];
  const numSV   = data[payloadStart +12];

  const lon = i32(data, payloadStart + 16) * 1e-7;
  const lat = i32(data, payloadStart + 20) * 1e-7;

  const gSpeed = i32(data, payloadStart + 36) / 1000 * 3.6; // mm/s ‚Üí km/h
  const heading = i32(data, payloadStart + 40) * 1e-5;

  const hAcc = u32(data, payloadStart + 28) / 1000;

  return {
    fixType, numSV, lat, lon, gSpeed, heading, hAcc,
    time: `${hour}:${min}:${sec}`
  };
}

function updateHz() {
  const now = performance.now();
  hzCounter.push(now);
  hzCounter = hzCounter.filter(t => now - t < 1000);
  document.getElementById('hz').textContent = hzCounter.length.toFixed(1) + ' Hz';
}

document.getElementById('connect').onclick = async () => {
  const device = await navigator.bluetooth.requestDevice({
    filters: [{ namePrefix: 'RaceBox Mini' }],
    optionalServices: [UART_SERVICE]
  });

  const server = await device.gatt.connect();
  const service = await server.getPrimaryService(UART_SERVICE);
  const tx = await service.getCharacteristic(UART_TX);

  await tx.startNotifications();

  tx.addEventListener('characteristicvaluechanged', e => {
    const data = new Uint8Array(e.target.value.buffer);
    const parsed = parseRaceBoxPacket(data);
    if (!parsed) return;

    document.getElementById('fix').textContent =
      parsed.fixType >= 3 ? '3D FIX' : 'NO FIX';

    document.getElementById('sv').textContent = parsed.numSV;
    document.getElementById('lat').textContent = parsed.lat.toFixed(7);
    document.getElementById('lon').textContent = parsed.lon.toFixed(7);
    document.getElementById('speed').textContent = parsed.gSpeed.toFixed(1) + ' km/h';
    document.getElementById('heading').textContent = parsed.heading.toFixed(1) + ' ¬∞';
    document.getElementById('acc').textContent = parsed.hAcc.toFixed(2) + ' m';

    updateHz();
  });
};
</script>

</body>
</html>
