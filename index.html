<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>RaceBox Mini ‚Äì GNSS + Map</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, monospace;
      background: #0b0b0b;
      color: #00ff9c;
      padding: 20px;
    }

    button {
      padding: 10px 16px;
      font-size: 16px;
      margin-bottom: 15px;
      cursor: pointer;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .card {
      background: #111;
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 0 10px #000;
    }

    .label {
      font-size: 13px;
      opacity: 0.7;
    }

    .value {
      font-size: 24px;
      font-weight: bold;
    }

    #map {
      height: 300px;
      border-radius: 12px;
      box-shadow: 0 0 10px #000;
    }
  </style>
</head>
<body>

<h1>üèÅ RaceBox Mini ‚Äì GNSS Dashboard</h1>

<button id="connect">üîó Connetti RaceBox</button>

<div class="grid">
  <div class="card"><div class="label">Fix</div><div id="fix" class="value">‚Äì</div></div>
  <div class="card"><div class="label">Satelliti</div><div id="sv" class="value">‚Äì</div></div>
  <div class="card"><div class="label">Velocit√†</div><div id="speed" class="value">‚Äì km/h</div></div>
  <div class="card"><div class="label">Heading</div><div id="heading" class="value">‚Äì ¬∞</div></div>
  <div class="card"><div class="label">Accuratezza</div><div id="acc" class="value">‚Äì m</div></div>
  <div class="card"><div class="label">Frequenza</div><div id="hz" class="value">‚Äì Hz</div></div>
</div>

<div id="map"></div>

<script>
/* =======================
   BLE UUID
======================= */
const UART_SERVICE = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const UART_TX = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

/* =======================
   Map
======================= */
const map = L.map('map').setView([0, 0], 2);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

let marker = null;
let track = L.polyline([], { color: '#00ff9c' }).addTo(map);

/* =======================
   Utils
======================= */
function u32(d, o) {
  return d[o] | (d[o+1]<<8) | (d[o+2]<<16) | (d[o+3]<<24);
}
function i32(d, o) {
  return (u32(d, o) << 0);
}

/* =======================
   Parser RaceBox (FIXED)
======================= */
function parseRaceBoxPacket(data) {
  if (data[0] !== 0xB5 || data[1] !== 0x62) return null;
  if (data[2] !== 0xFF || data[3] !== 0x01) return null;

  const p = 6; // payload start

  const fixType = data[p + 20];
  const numSV   = data[p + 21];

  const lon = i32(data, p + 24) * 1e-7;
  const lat = i32(data, p + 28) * 1e-7;

  const hAcc = u32(data, p + 32) / 1000;

  const gSpeed = u32(data, p + 36) / 1000 * 3.6;
  const heading = u32(data, p + 60) * 1e-5;

  return { fixType, numSV, lat, lon, gSpeed, heading, hAcc };
}

/* =======================
   Hz counter
======================= */
let hzTimes = [];
function updateHz() {
  const now = performance.now();
  hzTimes.push(now);
  hzTimes = hzTimes.filter(t => now - t < 1000);
  document.getElementById('hz').textContent = hzTimes.length.toFixed(1) + ' Hz';
}

/* =======================
   BLE connect
======================= */
document.getElementById('connect').onclick = async () => {
  const device = await navigator.bluetooth.requestDevice({
    filters: [{ namePrefix: 'RaceBox Mini' }],
    optionalServices: [UART_SERVICE]
  });

  const server = await device.gatt.connect();
  const service = await server.getPrimaryService(UART_SERVICE);
  const tx = await service.getCharacteristic(UART_TX);

  await tx.startNotifications();

  tx.addEventListener('characteristicvaluechanged', e => {
    const data = new Uint8Array(e.target.value.buffer);
    const p = parseRaceBoxPacket(data);
    if (!p) return;

    document.getElementById('fix').textContent =
      p.fixType >= 3 ? '3D FIX' : 'NO FIX';

    document.getElementById('sv').textContent = p.numSV;
    document.getElementById('speed').textContent = p.gSpeed.toFixed(1) + ' km/h';
    document.getElementById('heading').textContent = p.heading.toFixed(1) + ' ¬∞';
    document.getElementById('acc').textContent = p.hAcc.toFixed(2) + ' m';

    // MAP
    if (!marker) {
      marker = L.marker([p.lat, p.lon]).addTo(map);
      map.setView([p.lat, p.lon], 17);
    } else {
      marker.setLatLng([p.lat, p.lon]);
    }

    track.addLatLng([p.lat, p.lon]);

    updateHz();
  });
};
</script>

</body>
</html>
