<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>RaceBox Mini ‚Äì Complete Dashboard</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, monospace;
      background: #0b0b0b;
      color: #00ff9c;
      padding: 20px;
    }

    button {
      padding: 10px 16px;
      font-size: 16px;
      margin-bottom: 15px;
      cursor: pointer;
    }

    h2 {
      margin-top: 25px;
      margin-bottom: 10px;
      color: #00ccff;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 15px;
    }

    .card {
      background: #111;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 0 8px #000;
    }

    .label {
      font-size: 11px;
      opacity: 0.7;
      margin-bottom: 4px;
    }

    .value {
      font-size: 20px;
      font-weight: bold;
    }

    .value.small {
      font-size: 16px;
    }

    #map {
      height: 300px;
      border-radius: 12px;
      box-shadow: 0 0 10px #000;
      margin-bottom: 20px;
    }

    .battery {
      background: linear-gradient(90deg, #00ff9c, #00cc7a);
      padding: 2px 8px;
      border-radius: 4px;
      color: #000;
      font-weight: bold;
      display: inline-block;
    }
  </style>
</head>
<body>

<h1>üèÅ RaceBox Mini ‚Äì Complete Dashboard</h1>

<button id="connect">üîó Connetti RaceBox</button>

<!-- GPS RECEIVER -->
<h2>üì° GPS Receiver</h2>
<div class="grid">
  <div class="card">
    <div class="label">Time (UTC)</div>
    <div id="time" class="value small">‚Äì</div>
  </div>
  <div class="card">
    <div class="label">Fix type</div>
    <div id="fix" class="value small">‚Äì</div>
  </div>
  <div class="card">
    <div class="label">Satellites</div>
    <div id="sv" class="value">‚Äì</div>
  </div>
  <div class="card">
    <div class="label">Frequency</div>
    <div id="hz" class="value">‚Äì Hz</div>
  </div>
  <div class="card">
    <div class="label">Battery</div>
    <div id="battery" class="value">‚Äì</div>
  </div>
  <div class="card">
    <div class="label">PDOP</div>
    <div id="pdop" class="value small">‚Äì</div>
  </div>
</div>

<!-- POSITION -->
<h2>üìç Position</h2>
<div class="grid">
  <div class="card">
    <div class="label">Latitude</div>
    <div id="lat" class="value small">‚Äì</div>
  </div>
  <div class="card">
    <div class="label">Longitude</div>
    <div id="lon" class="value small">‚Äì</div>
  </div>
  <div class="card">
    <div class="label">Altitude (WGS84)</div>
    <div id="alt_wgs" class="value small">‚Äì m</div>
  </div>
  <div class="card">
    <div class="label">Altitude (MSL)</div>
    <div id="alt_msl" class="value small">‚Äì m</div>
  </div>
  <div class="card">
    <div class="label">Accuracy (H)</div>
    <div id="acc_h" class="value small">‚Äì m</div>
  </div>
  <div class="card">
    <div class="label">Accuracy (V)</div>
    <div id="acc_v" class="value small">‚Äì m</div>
  </div>
</div>

<!-- MOTION -->
<h2>üèéÔ∏è Motion</h2>
<div class="grid">
  <div class="card">
    <div class="label">Speed</div>
    <div id="speed" class="value">‚Äì km/h</div>
  </div>
  <div class="card">
    <div class="label">Heading</div>
    <div id="heading" class="value">‚Äì ¬∞</div>
  </div>
  <div class="card">
    <div class="label">Speed Accuracy</div>
    <div id="speed_acc" class="value small">‚Äì km/h</div>
  </div>
  <div class="card">
    <div class="label">Heading Accuracy</div>
    <div id="heading_acc" class="value small">‚Äì ¬∞</div>
  </div>
</div>

<!-- ACCELEROMETER -->
<h2>‚ö° Accelerometer</h2>
<div class="grid">
  <div class="card">
    <div class="label">X (front/back)</div>
    <div id="acc_x" class="value small">‚Äì G</div>
  </div>
  <div class="card">
    <div class="label">Y (right/left)</div>
    <div id="acc_y" class="value small">‚Äì G</div>
  </div>
  <div class="card">
    <div class="label">Z (up/down)</div>
    <div id="acc_z" class="value small">‚Äì G</div>
  </div>
</div>

<!-- GYROSCOPE -->
<h2>üîÑ Gyroscope</h2>
<div class="grid">
  <div class="card">
    <div class="label">X (roll)</div>
    <div id="gyro_x" class="value small">‚Äì ¬∞/s</div>
  </div>
  <div class="card">
    <div class="label">Y (pitch)</div>
    <div id="gyro_y" class="value small">‚Äì ¬∞/s</div>
  </div>
  <div class="card">
    <div class="label">Z (yaw)</div>
    <div id="gyro_z" class="value small">‚Äì ¬∞/s</div>
  </div>
</div>

<!-- MAP -->
<h2>üó∫Ô∏è Map</h2>
<div id="map"></div>

<script>
/* =======================
   BLE UUID
======================= */
const UART_SERVICE = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const UART_TX = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

/* =======================
   Map
======================= */
const map = L.map('map').setView([0, 0], 2);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

let marker = null;
let track = L.polyline([], { color: '#00ff9c' }).addTo(map);

/* =======================
   Utils
======================= */
function u8(d, o) {
  return d[o];
}
function u16(d, o) {
  return d[o] | (d[o+1]<<8);
}
function i16(d, o) {
  const val = u16(d, o);
  return val > 32767 ? val - 65536 : val;
}
function u32(d, o) {
  return d[o] | (d[o+1]<<8) | (d[o+2]<<16) | (d[o+3]<<24);
}
function i32(d, o) {
  return (u32(d, o) << 0);
}

/* =======================
   Parser RaceBox COMPLETO
======================= */
function parseRaceBoxPacket(data) {
  if (data[0] !== 0xB5 || data[1] !== 0x62) return null;
  if (data[2] !== 0xFF || data[3] !== 0x01) return null;

  const p = 6; // payload start

  // TEMPO
  const year = u16(data, p + 4);
  const month = u8(data, p + 6);
  const day = u8(data, p + 7);
  const hour = u8(data, p + 8);
  const minute = u8(data, p + 9);
  const second = u8(data, p + 10);
  const timeStr = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')} ${String(hour).padStart(2,'0')}:${String(minute).padStart(2,'0')}:${String(second).padStart(2,'0')}`;

  // FIX
  const fixType = u8(data, p + 20);
  const numSV = u8(data, p + 23);

  // POSIZIONE
  const lon = i32(data, p + 24) * 1e-7;
  const lat = i32(data, p + 28) * 1e-7;
  const altWGS = i32(data, p + 32) / 1000; // mm -> m
  const altMSL = i32(data, p + 36) / 1000; // mm -> m

  // ACCURATEZZA
  const hAcc = u32(data, p + 40) / 1000; // mm -> m
  const vAcc = u32(data, p + 44) / 1000; // mm -> m

  // VELOCITA' E HEADING
  const speedMmS = i32(data, p + 48);
  const gSpeed = (speedMmS / 1000) * 3.6; // mm/s -> km/h
  
  const headingRaw = i32(data, p + 52);
  const heading = headingRaw / 100000; // gradi * 10^5 -> gradi

  const speedAcc = u32(data, p + 56) / 1000 * 3.6; // mm/s -> km/h
  const headingAcc = u32(data, p + 60) / 100000; // gradi * 10^5 -> gradi

  // PDOP
  const pdop = u16(data, p + 64) / 100;

  // BATTERIA
  const battery = u8(data, p + 67); // % per Mini

  // ACCELEROMETRO (milli-g)
  const accX = i16(data, p + 68) / 1000; // G
  const accY = i16(data, p + 70) / 1000; // G
  const accZ = i16(data, p + 72) / 1000; // G

  // GIROSCOPIO (centi-gradi/s)
  const gyroX = i16(data, p + 74) / 100; // ¬∞/s
  const gyroY = i16(data, p + 76) / 100; // ¬∞/s
  const gyroZ = i16(data, p + 78) / 100; // ¬∞/s

  return {
    timeStr, fixType, numSV, pdop, battery,
    lat, lon, altWGS, altMSL, hAcc, vAcc,
    gSpeed, heading, speedAcc, headingAcc,
    accX, accY, accZ,
    gyroX, gyroY, gyroZ
  };
}

/* =======================
   Hz counter
======================= */
let hzTimes = [];
function updateHz() {
  const now = performance.now();
  hzTimes.push(now);
  hzTimes = hzTimes.filter(t => now - t < 1000);
  return hzTimes.length;
}

/* =======================
   BLE connect
======================= */
document.getElementById('connect').onclick = async () => {
  const device = await navigator.bluetooth.requestDevice({
    filters: [{ namePrefix: 'RaceBox Mini' }],
    optionalServices: [UART_SERVICE]
  });

  const server = await device.gatt.connect();
  const service = await server.getPrimaryService(UART_SERVICE);
  const tx = await service.getCharacteristic(UART_TX);

  await tx.startNotifications();

  tx.addEventListener('characteristicvaluechanged', e => {
    const data = new Uint8Array(e.target.value.buffer);
    const p = parseRaceBoxPacket(data);
    if (!p) return;

    const hz = updateHz();

    // GPS RECEIVER
    document.getElementById('time').textContent = p.timeStr;
    document.getElementById('fix').textContent = p.fixType >= 3 ? '3D FIX' : 'NO FIX';
    document.getElementById('sv').textContent = p.numSV + ' sats';
    document.getElementById('hz').textContent = hz.toFixed(1) + ' Hz';
    document.getElementById('battery').innerHTML = `<span class="battery">${p.battery}%</span>`;
    document.getElementById('pdop').textContent = p.pdop.toFixed(2);

    // POSITION
    document.getElementById('lat').textContent = p.lat.toFixed(6);
    document.getElementById('lon').textContent = p.lon.toFixed(6);
    document.getElementById('alt_wgs').textContent = p.altWGS.toFixed(1) + ' m';
    document.getElementById('alt_msl').textContent = p.altMSL.toFixed(1) + ' m';
    document.getElementById('acc_h').textContent = p.hAcc.toFixed(2) + ' m';
    document.getElementById('acc_v').textContent = p.vAcc.toFixed(2) + ' m';

    // MOTION
    document.getElementById('speed').textContent = p.gSpeed.toFixed(1) + ' km/h';
    document.getElementById('heading').textContent = p.heading.toFixed(1) + ' ¬∞';
    document.getElementById('speed_acc').textContent = p.speedAcc.toFixed(2) + ' km/h';
    document.getElementById('heading_acc').textContent = p.headingAcc.toFixed(2) + ' ¬∞';

    // ACCELEROMETER
    document.getElementById('acc_x').textContent = p.accX.toFixed(2) + ' G';
    document.getElementById('acc_y').textContent = p.accY.toFixed(2) + ' G';
    document.getElementById('acc_z').textContent = p.accZ.toFixed(2) + ' G';

    // GYROSCOPE
    document.getElementById('gyro_x').textContent = p.gyroX.toFixed(1) + ' ¬∞/s';
    document.getElementById('gyro_y').textContent = p.gyroY.toFixed(1) + ' ¬∞/s';
    document.getElementById('gyro_z').textContent = p.gyroZ.toFixed(1) + ' ¬∞/s';

    // MAP
    if (!marker) {
      marker = L.marker([p.lat, p.lon]).addTo(map);
      map.setView([p.lat, p.lon], 17);
    } else {
      marker.setLatLng([p.lat, p.lon]);
    }

    track.addLatLng([p.lat, p.lon]);
  });
};
</script>

</body>
</html>
